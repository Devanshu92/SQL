/* USER PURCHASE PLATFORM.
-- THE TABLE LOGS THE SPENDINGS HISTORY OF USERS THAT MAKE PURCHASES FROM AN ONLINE SHOPPING WEBSITE WHICH HAS A DESKTOP 
AND A MOBILE APPLICATION.
-- WRITE AN SQL QUERY TO FIND THE TOTAL NUMBER OF USERS AND THE TOTAL AMOUNT SPENT USING MOBILE ONLY, DESKTOP ONLY 
AND BOTH MOBILE AND DESKTOP TOGETHER FOR EACH DATE.
*/

Input Table - Spending 

User_ID	Spend_Date	Platform	Amount
1	7/1/2019	MOBILE	100
1	7/1/2019	DESKTOP	100
2	7/1/2019	MOBILE	100
2	7/2/2019	MOBILE	100
3	7/1/2019	DESKTOP	100
3	7/2/2019	DESKTOP	100



Output 

Spend_Date	Platform	Total_Amt Total_Users
7/1/2019	DESKTOP	100  1
7/1/2019	MOBILE	100  1
7/1/2019	BOTH	200  1
7/2/2019	DESKTOP	100  1
7/2/2019	MOBILE	100  1
7/2/2019        BOTH    0    0 



DROP TABLE IF EXISTS ; 
CREATE TABLE SPENDING 
(
USER_ID INT,
SPEND_DATE DATE,
PLATFORM VARCHAR(10),
AMOUNT INT
);

INSERT INTO SPENDING VALUES
(1,'2019-07-01','MOBILE',100),
(1,'2019-07-01','DESKTOP',100),
(2,'2019-07-01','MOBILE',100),
(2,'2019-07-02','MOBILE',100),
(3,'2019-07-01','DESKTOP',100),
(3,'2019-07-02','DESKTOP',100);

--- Solution 1 ------

WITH CTE AS
(
SELECT S.SPEND_DATE,CASE WHEN PLATFORM_CNT_USER = 2 THEN 'BOTH' ELSE S.PLATFORM END AS PLATFORM,SUM(AMOUNT) AS TOTAL_AMT,COUNT(DISTINCT S.USER_ID) AS TOTAL_USERS
FROM SPENDING S
LEFT JOIN
(SELECT USER_ID, SPEND_DATE, COUNT(*) AS PLATFORM_CNT_USER FROM SPENDING GROUP BY 1, 2) A
ON S.USER_ID = A.USER_ID
AND S.SPEND_DATE = A.SPEND_DATE
GROUP BY 1,2

UNION ALL

SELECT DISTINCT SPEND_DATE,'BOTH' AS PLATFORM,0 AS AMT,0 AS TOTAL_USERS FROM SPENDING
)

SELECT SPEND_DATE,PLATFORM,SUM(TOTAL_AMT) AS TOTAL_AMT,SUM(TOTAL_USERS) AS TOTAL_USERS
FROM CTE
GROUP BY 1,2

--- Solution 2 ------

SELECT SPEND_DATE,PLATFORM,SUM(AMOUNT) AS TOTAL_AMOUNT,COUNT(DISTINCT USER_ID) AS TOTAL_USERS
FROM
(
SELECT SPEND_DATE,USER_ID,MAX(PLATFORM) AS PLATFORM,SUM(AMOUNT) AS AMOUNT
FROM SPENDING
GROUP BY SPEND_DATE,USER_ID
HAVING COUNT(DISTINCT PLATFORM) = 1

UNION ALL

SELECT SPEND_DATE,USER_ID,'BOTH' AS PLATFORM,SUM(AMOUNT) AS AMOUNT
FROM SPENDING
GROUP BY SPEND_DATE,USER_ID HAVING COUNT(DISTINCT PLATFORM) = 2

UNION ALL

SELECT DISTINCT SPEND_DATE,NULL::INT AS USER_ID, 'BOTH' AS PLATFORM, 0 AS AMOUNT
FROM SPENDING
)
GROUP BY SPEND_DATE, PLATFORM